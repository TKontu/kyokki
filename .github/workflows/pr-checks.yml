name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title-check:
    name: Check PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const validPrefixes = ['feat:', 'fix:', 'docs:', 'refactor:', 'test:', 'chore:', 'style:', 'perf:', 'ci:', 'build:'];

            const hasValidPrefix = validPrefixes.some(prefix =>
              title.toLowerCase().startsWith(prefix)
            );

            if (!hasValidPrefix) {
              core.setFailed(
                `PR title should start with one of: ${validPrefixes.join(', ')}\n` +
                `Current title: "${title}"\n` +
                `Example: "feat: add shopping list API endpoints"`
              );
            } else {
              console.log(`âœ… PR title format is valid: "${title}"`);
            }

  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            let sizeLabel = '';
            let emoji = '';

            if (totalChanges < 100) {
              sizeLabel = 'size/XS';
              emoji = 'ðŸŸ¢';
            } else if (totalChanges < 300) {
              sizeLabel = 'size/S';
              emoji = 'ðŸŸ¢';
            } else if (totalChanges < 600) {
              sizeLabel = 'size/M';
              emoji = 'ðŸŸ¡';
            } else if (totalChanges < 1200) {
              sizeLabel = 'size/L';
              emoji = 'ðŸŸ ';
            } else {
              sizeLabel = 'size/XL';
              emoji = 'ðŸ”´';
            }

            console.log(`${emoji} PR Size: ${sizeLabel}`);
            console.log(`ðŸ“Š Changes: +${additions} -${deletions} = ${totalChanges} lines`);

            if (totalChanges > 1200) {
              core.warning(
                'âš ï¸ This PR is quite large. Consider breaking it into smaller PRs for easier review.'
              );
            }

            // Add size label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [sizeLabel]
              });
            } catch (error) {
              console.log('Could not add label (may need to create labels first)');
            }

  check-dependencies:
    name: Check for Dependency Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for dependency file changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const depFiles = [
              'requirements.txt',
              'package.json',
              'package-lock.json',
              'Pipfile',
              'Pipfile.lock',
              'poetry.lock'
            ];

            const changedDepFiles = files
              .map(f => f.filename)
              .filter(name => depFiles.some(dep => name.includes(dep)));

            if (changedDepFiles.length > 0) {
              console.log('âš ï¸ Dependency files changed:');
              changedDepFiles.forEach(file => console.log(`  - ${file}`));

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: 'âš ï¸ **Dependency Changes Detected**\n\n' +
                      'This PR modifies dependency files:\n' +
                      changedDepFiles.map(f => `- \`${f}\``).join('\n') +
                      '\n\nPlease ensure:\n' +
                      '- [ ] Dependencies are necessary for the feature/fix\n' +
                      '- [ ] No known security vulnerabilities\n' +
                      '- [ ] Versions are pinned appropriately'
              });
            }
